/* Surgery Types for Nursing Staff */

    DROP TABLE NURSE_SURG_TYPE;
    
    CREATE TABLE NURSE_SURG_TYPE (
        EmpNo INTEGER PRIMARY KEY, 
        Type INTEGER NOT NULL,
        FOREIGN KEY (EmpNo) REFERENCES STAFF(EmpNo)
            ON UPDATE CASCADE
            ON DELETE CASCADE,
        FOREIGN KEY (Type) REFERENCES SURG_TYPE (Code)
            ON UPDATE CASCADE
            ON DELETE CASCADE
    );

/* Trigger to make sure a newly inserted Nurse Surgery Type has an EmpType of 'NURS' and possesses at least 1 of the minimum skills for surgery type */

    CREATE TRIGGER CHECK_NURSE_SURG_TYPE_INSERT
    BEFORE INSERT ON NURSE_SURG_TYPE
    FOR EACH ROW
    WHEN NOT EXISTS (
        SELECT 1 FROM STAFF WHERE EmpNo = NEW.EmpNo AND EmpType = 'NURS'
    ) OR NOT EXISTS (
        SELECT 1 FROM SURG_TYPE_SKILL A
        WHERE A.Type = NEW.Type AND EXISTS (
            SELECT 1 FROM NURSE_SURG_SKILL B
            WHERE B.EmpNo = NEW.EmpNo AND B.Skill = A.Skill
            LIMIT 1
        )
    )
    BEGIN
        SELECT RAISE (ABORT, 'The selected employee must be a Nurse with at least one Skill for the selected Surgery Type.');
    END;

/* Trigger to make sure an updated Nurse Surgery Type has an EmpType of 'NURS' and possesses at least 1 of the minimum skills for surgery type */

    CREATE TRIGGER CHECK_NURSE_SURG_TYPE_UPDATE
    BEFORE UPDATE ON NURSE_SURG_TYPE
    FOR EACH ROW
    WHEN NOT EXISTS (
        SELECT 1 FROM STAFF WHERE EmpNo = NEW.EmpNo AND EmpType = 'NURS'
    ) OR NOT EXISTS (
        SELECT 1 FROM SURG_TYPE_SKILL A
        WHERE A.Type = NEW.Type AND EXISTS (
            SELECT 1 FROM NURSE_SURG_SKILL B
            WHERE B.EmpNo = NEW.EmpNo AND B.Skill = A.Skill
            LIMIT 1
        )
    )
    BEGIN
        SELECT RAISE (ABORT, 'The selected employee must be a Nurse with at least one Skill for the selected Surgery Type.');
    END;