/* Trigger to make sure an updated patient illness's Appointment belongs to the patient and has a Type of 'Consultation' */

DROP TRIGGER CHECK_PATIENT_ILLNESS_APPT_UPDATE;

CREATE TRIGGER CHECK_PATIENT_ILLNESS_APPT_UPDATE
BEFORE UPDATE ON PATIENT_ILLNESS
FOR EACH ROW
WHEN NOT EXISTS (
    SELECT 1 FROM APPOINTMENT WHERE PatientNo = NEW.PatientNo AND AppointmentNo = NEW.AppointmentNo AND Type = 'Consultation'
)
BEGIN
    SELECT RAISE (ABORT, 'The selected Appointment must be a Consultation that belongs to the selected Patient.');
END;