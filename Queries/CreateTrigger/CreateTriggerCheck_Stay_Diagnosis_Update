/* Trigger to make sure an updated in-patient stay's Diagnosis belongs to that Patient */

DROP TRIGGER CHECK_STAY_DIAGNOSIS_UPDATE;

CREATE TRIGGER CHECK_STAY_DIAGNOSIS_UPDATE
BEFORE UPDATE ON STAY
FOR EACH ROW
WHEN NOT EXISTS (
    SELECT 1 FROM PATIENT_ILLNESS WHERE DiagnosisNo = NEW.DiagnosisNo AND PatientNo = NEW.PatientNo)
BEGIN
    SELECT RAISE (ABORT, 'The selected Diagnosis must belong to the selected Patient.');
END;