/* Trigger to make sure an updated in-patient stay's Nurse has an EmpType of 'NURS' and that removal of a Nurse does not place a Nurse's total patient count below 5 */

DROP TRIGGER CHECK_STAY_NURSE_UPDATE;

CREATE TRIGGER CHECK_STAY_NURSE_UPDATE
BEFORE UPDATE ON STAY
FOR EACH ROW
WHEN NEW.Nurse IS NOT NULL AND NOT EXISTS (
    SELECT 1 FROM STAFF WHERE EmpNo = NEW.Nurse AND EmpType = 'NURS'
) OR (NEW.Nurse IS NULL AND (
    SELECT COUNT(*) FROM STAY WHERE Nurse = OLD.Nurse) = 5
)
BEGIN
    SELECT RAISE (ABORT, 'The selected attending Nurse must be a Nurse and Patients cannot be deleted from Nurses without at least 5 other Patients.');
END;